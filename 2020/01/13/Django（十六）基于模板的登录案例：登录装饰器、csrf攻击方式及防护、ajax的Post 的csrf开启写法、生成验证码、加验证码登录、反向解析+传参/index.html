<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/myblog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/myblog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/myblog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/myblog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/myblog/css/main.css">


<link rel="stylesheet" href="/myblog/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pasaulis.gitee.io","root":"/myblog/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="一、csrf攻击1.1 csrf攻击（跨站请求伪造）【csrf攻击即】：通过第3方网站，伪造请求（前提条件是你已经登录正常网站，并保存了session或cookie登录信息且没有退出），第三方网站即可通过你的session或cookie直接修改正常网站的用户名密码。">
<meta property="og:type" content="article">
<meta property="og:title" content="Django（十六）基于模板的登录案例：登录装饰器、csrf攻击方式及防护、ajax的Post 的csrf开启写法、生成验证码、加验证码登录、反向解析+传参">
<meta property="og:url" content="https://pasaulis.gitee.io/myblog/2020/01/13/Django%EF%BC%88%E5%8D%81%E5%85%AD%EF%BC%89%E5%9F%BA%E4%BA%8E%E6%A8%A1%E6%9D%BF%E7%9A%84%E7%99%BB%E5%BD%95%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%99%BB%E5%BD%95%E8%A3%85%E9%A5%B0%E5%99%A8%E3%80%81csrf%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E5%8F%8A%E9%98%B2%E6%8A%A4%E3%80%81ajax%E7%9A%84Post%20%E7%9A%84csrf%E5%BC%80%E5%90%AF%E5%86%99%E6%B3%95%E3%80%81%E7%94%9F%E6%88%90%E9%AA%8C%E8%AF%81%E7%A0%81%E3%80%81%E5%8A%A0%E9%AA%8C%E8%AF%81%E7%A0%81%E7%99%BB%E5%BD%95%E3%80%81%E5%8F%8D%E5%90%91%E8%A7%A3%E6%9E%90+%E4%BC%A0%E5%8F%82/index.html">
<meta property="og:site_name" content="晨曦的博客">
<meta property="og:description" content="一、csrf攻击1.1 csrf攻击（跨站请求伪造）【csrf攻击即】：通过第3方网站，伪造请求（前提条件是你已经登录正常网站，并保存了session或cookie登录信息且没有退出），第三方网站即可通过你的session或cookie直接修改正常网站的用户名密码。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200112104459990.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTAxMzIxNzc=,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200112103417716.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200112103710743.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200112111619881.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200112155943850.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200112163623257.png">
<meta property="article:published_time" content="2020-01-13T03:34:25.000Z">
<meta property="article:modified_time" content="2020-03-23T03:01:39.588Z">
<meta property="article:author" content="晨曦">
<meta property="article:tag" content="python">
<meta property="article:tag" content="vue">
<meta property="article:tag" content="react">
<meta property="article:tag" content="AI">
<meta property="article:tag" content="人工智能">
<meta property="article:tag" content="爬虫">
<meta property="article:tag" content="大数据分析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/20200112104459990.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTAxMzIxNzc=,size_16,color_FFFFFF,t_70">

<link rel="canonical" href="https://pasaulis.gitee.io/myblog/2020/01/13/Django%EF%BC%88%E5%8D%81%E5%85%AD%EF%BC%89%E5%9F%BA%E4%BA%8E%E6%A8%A1%E6%9D%BF%E7%9A%84%E7%99%BB%E5%BD%95%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%99%BB%E5%BD%95%E8%A3%85%E9%A5%B0%E5%99%A8%E3%80%81csrf%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E5%8F%8A%E9%98%B2%E6%8A%A4%E3%80%81ajax%E7%9A%84Post%20%E7%9A%84csrf%E5%BC%80%E5%90%AF%E5%86%99%E6%B3%95%E3%80%81%E7%94%9F%E6%88%90%E9%AA%8C%E8%AF%81%E7%A0%81%E3%80%81%E5%8A%A0%E9%AA%8C%E8%AF%81%E7%A0%81%E7%99%BB%E5%BD%95%E3%80%81%E5%8F%8D%E5%90%91%E8%A7%A3%E6%9E%90+%E4%BC%A0%E5%8F%82/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Django（十六）基于模板的登录案例：登录装饰器、csrf攻击方式及防护、ajax的Post 的csrf开启写法、生成验证码、加验证码登录、反向解析+传参 | 晨曦的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/myblog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">晨曦的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">技术博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/myblog/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/myblog/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/myblog/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/myblog/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/myblog/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pasaulis.gitee.io/myblog/2020/01/13/Django%EF%BC%88%E5%8D%81%E5%85%AD%EF%BC%89%E5%9F%BA%E4%BA%8E%E6%A8%A1%E6%9D%BF%E7%9A%84%E7%99%BB%E5%BD%95%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%99%BB%E5%BD%95%E8%A3%85%E9%A5%B0%E5%99%A8%E3%80%81csrf%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E5%8F%8A%E9%98%B2%E6%8A%A4%E3%80%81ajax%E7%9A%84Post%20%E7%9A%84csrf%E5%BC%80%E5%90%AF%E5%86%99%E6%B3%95%E3%80%81%E7%94%9F%E6%88%90%E9%AA%8C%E8%AF%81%E7%A0%81%E3%80%81%E5%8A%A0%E9%AA%8C%E8%AF%81%E7%A0%81%E7%99%BB%E5%BD%95%E3%80%81%E5%8F%8D%E5%90%91%E8%A7%A3%E6%9E%90+%E4%BC%A0%E5%8F%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://www.zeyajt.com/u/40b74ddb-a87b-41cd-821b-3f6eeb544661/image/637203952121373129.jpg">
      <meta itemprop="name" content="晨曦">
      <meta itemprop="description" content="晨曦的技术博客，专注于python、vue、react、人工智能、爬虫、大数据分析">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="晨曦的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Django（十六）基于模板的登录案例：登录装饰器、csrf攻击方式及防护、ajax的Post 的csrf开启写法、生成验证码、加验证码登录、反向解析+传参
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-13 11:34:25" itemprop="dateCreated datePublished" datetime="2020-01-13T11:34:25+08:00">2020-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-03-23 11:01:39" itemprop="dateModified" datetime="2020-03-23T11:01:39+08:00">2020-03-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/myblog/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/myblog/categories/python/Django/" itemprop="url" rel="index"><span itemprop="name">Django</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="一、csrf攻击"><a href="#一、csrf攻击" class="headerlink" title="一、csrf攻击"></a>一、csrf攻击</h1><h2 id="1-1-csrf攻击（跨站请求伪造）"><a href="#1-1-csrf攻击（跨站请求伪造）" class="headerlink" title="1.1 csrf攻击（跨站请求伪造）"></a>1.1 csrf攻击（跨站请求伪造）</h2><p>【csrf攻击即】：通过第3方网站，伪造请求（前提条件是你已经登录正常网站，并保存了session或cookie登录信息且没有退出），第三方网站即可通过你的session或cookie直接修改正常网站的用户名密码。</p>
<a id="more"></a>
<p><img src="https://img-blog.csdnimg.cn/20200112104459990.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTAxMzIxNzc=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ol>
<li>首先做一个登录页，让用户输入用户名和密码进行登录，登录成功之后跳转的修改密码页面。在修改密码页面输入新密码，点击确认按钮完成密码修改。</li>
<li>登录页需要一个模板文件login.html.修改密码页面也需要一个模板文件change_pwd.html.</li>
<li>显示登录页的视图login，验证登录的视图login_check，显示发帖页的视图change_pwd,处理修改密码的视图change_pwd_action.</li>
<li>加功能：<br>a)只有用户登录之后才可以进行修改密码操作。</li>
<li><font color='red'>登录装饰器函数（app2/views.py）：</font><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_required</span><span class="params">(view_func)</span>:</span> <span class="comment">#参数即调用它的函数</span></span><br><span class="line">    <span class="string">'''登录判断装饰器'''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(request, *view_args, **view_kwargs)</span>:</span> <span class="comment"># 内部函数，包装一下</span></span><br><span class="line">        <span class="comment"># 判断用户是否登录</span></span><br><span class="line">        <span class="keyword">if</span> request.session.has_key(<span class="string">'islogin'</span>): <span class="comment">#如果登录了，就返回真正页面（调用此装饰器函数的函数）</span></span><br><span class="line">            <span class="comment"># 用户已登录,调用对应的视图</span></span><br><span class="line">            <span class="keyword">return</span> view_func(request, *view_args, **view_kwargs)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 否则，用户未登录,则跳转到登录页</span></span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'/login'</span>)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure></li>
<li>登录装饰器调用，比如一个页面必须要登录才能操作，否则跳转到登录页<br>【app2/views.py】<code>@login_required</code><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /change_pwd</span></span><br><span class="line"><span class="meta">@login_required #作用：把此页面作为一个参数传到login_required里</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_pwd</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''显示修改密码页面'''</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'booktest/change_pwd.html'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="【csrf攻击改密码实例】（必须登录后才能操作）："><a href="#【csrf攻击改密码实例】（必须登录后才能操作）：" class="headerlink" title="【csrf攻击改密码实例】（必须登录后才能操作）："></a>【csrf攻击改密码实例】（必须登录后才能操作）：</h3><h4 id="1-project2-settings-py-注释掉csrf"><a href="#1-project2-settings-py-注释掉csrf" class="headerlink" title="1) project2/settings.py 注释掉csrf"></a>1) project2/settings.py 注释掉csrf</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">'django.middleware.security.SecurityMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.sessions.middleware.SessionMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.common.CommonMiddleware'</span>,</span><br><span class="line">   <span class="comment"># 'django.middleware.csrf.CsrfViewMiddleware',</span></span><br><span class="line">    <span class="string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages.middleware.MessageMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="2）templates-change-pwd-html"><a href="#2）templates-change-pwd-html" class="headerlink" title="2）templates/change_pwd.html"></a>2）templates/change_pwd.html</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;修改密码页面&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form method=<span class="string">"post"</span> action=<span class="string">"/change_pwd_action/"</span>&gt;</span><br><span class="line">    新密码:&lt;input type=<span class="string">"password"</span> name=<span class="string">"pwd"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> value=<span class="string">"确认修改"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h4 id="3-app2-views-py【登录装饰器】"><a href="#3-app2-views-py【登录装饰器】" class="headerlink" title="3) app2/views.py【登录装饰器】"></a><font color='red'>3) app2/views.py【登录装饰器】</font></h4>【1】登录装饰器：用户已登录,调用对应的视图；用户未登录,跳转到登录页<br>【2】需要登录才能操作的页面调用登录装饰器<br>【3】需要登录才能操作的页面调用登录装饰器<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render,redirect</span><br><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> loader,RequestContext</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse,JsonResponse</span><br><span class="line"><span class="keyword">from</span> app2.models <span class="keyword">import</span> BookInfo</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''登录页'''</span></span><br><span class="line">    <span class="comment"># 判断用户是否登录，用户已登录, 直接跳转到图书列表</span></span><br><span class="line">    <span class="keyword">if</span> request.session.has_key(<span class="string">'islogin'</span>):</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'/change_pwd/'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment">#如果用户名密码已经在cookie中，则取到它，并做为参数返回给渲染页面</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'username'</span> <span class="keyword">in</span> request.COOKIES:</span><br><span class="line">            <span class="comment">#获取cookie中的用户名、密码</span></span><br><span class="line">            username=request.COOKIES[<span class="string">'username'</span>]</span><br><span class="line">            <span class="comment">#password=request.COOKIES['password']</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            username=<span class="string">''</span></span><br><span class="line">            password=<span class="string">''</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'app2/login.html'</span>,&#123;<span class="string">'username'</span>:username,<span class="string">'password'</span>:password&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_check</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''登录校验'''</span></span><br><span class="line">    <span class="comment">#1.获取用户名密码</span></span><br><span class="line">    username=request.POST.get(<span class="string">'username'</span>)</span><br><span class="line">    password=request.POST.get(<span class="string">'password'</span>)</span><br><span class="line">    remember=request.POST.get(<span class="string">'remember'</span>) <span class="comment">#接收remeber</span></span><br><span class="line">    <span class="comment">#2.进行校验，并返回json数据</span></span><br><span class="line">    <span class="keyword">if</span> username==<span class="string">'jim'</span> <span class="keyword">and</span> password==<span class="string">'123'</span>:</span><br><span class="line">        <span class="comment">#return redirect('/books')</span></span><br><span class="line">        response = JsonResponse(&#123;<span class="string">'res'</span>:<span class="number">1</span>&#125;) <span class="comment">#正确返回1，重写</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#如果remember==on，则把用户名,密码设置cookie到cookie</span></span><br><span class="line">        <span class="keyword">if</span> remember==<span class="string">'on'</span>:</span><br><span class="line">            <span class="comment">#response.set_cookie('username',username,max_age=7*24*3600)</span></span><br><span class="line">            <span class="comment">#response.set_cookie('password',password,max_age=7*24*3600)</span></span><br><span class="line">            <span class="comment"># 记住用户登录状态把用户名设置到session</span></span><br><span class="line">            request.session[<span class="string">'username'</span>] = username</span><br><span class="line">            <span class="comment"># 返回应答</span></span><br><span class="line">            <span class="comment"># 如果用户勾选了remember的条件下，设置session,记住用户登录状态</span></span><br><span class="line">            request.session[<span class="string">'islogin'</span>] = <span class="literal">True</span> <span class="comment"># 只有session中有islogin,就认为用户已登录</span></span><br><span class="line">        <span class="keyword">return</span> response <span class="comment">#不要忘记返回response</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment">#return redirect('/login')</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>:<span class="number">0</span>&#125;) <span class="comment">#错误返回0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#【1】登录装饰器：用户已登录,调用对应的视图；用户未登录,跳转到登录页</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_required</span><span class="params">(view_func)</span>:</span></span><br><span class="line">    <span class="string">'''登录判断装饰器'''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(request, *view_args, **view_kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 判断用户是否登录</span></span><br><span class="line">        <span class="keyword">if</span> request.session.has_key(<span class="string">'islogin'</span>):</span><br><span class="line">            <span class="comment"># 用户已登录,调用对应的视图</span></span><br><span class="line">            <span class="keyword">return</span> view_func(request, *view_args, **view_kwargs)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 用户未登录,跳转到登录页</span></span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'/login'</span>)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># /change_pwd</span></span><br><span class="line"><span class="meta">@login_required #【2】需要登录才能操作的页面调用登录装饰器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_pwd</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''显示修改密码页面'''</span></span><br><span class="line">    <span class="comment"># # 进行用户是否登录的判断</span></span><br><span class="line">    <span class="comment"># if not request.session.has_key('islogin'):</span></span><br><span class="line">    <span class="comment">#     # 用户未登录，跳转到登录</span></span><br><span class="line">    <span class="comment">#     return redirect('/login')</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'app2/change_pwd.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># /change_pwd_action</span></span><br><span class="line"><span class="meta">@login_required #【3】需要登录才能操作的页面调用登录装饰器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_pwd_action</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''模拟修改密码处理'''</span></span><br><span class="line">    <span class="comment"># # 进行用户是否登录的判断</span></span><br><span class="line">    <span class="comment"># if not request.session.has_key('islogin'):</span></span><br><span class="line">    <span class="comment">#     # 用户未登录，跳转到登录</span></span><br><span class="line">    <span class="comment">#     return redirect('/login')</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.获取新密码</span></span><br><span class="line">    pwd = request.POST.get(<span class="string">'pwd'</span>)</span><br><span class="line">    <span class="comment"># 获取用户名</span></span><br><span class="line">    username = request.session.get(<span class="string">'username'</span>)</span><br><span class="line">    <span class="comment"># 2.实际开发的时候: 修改对应数据库中的内容...</span></span><br><span class="line">    <span class="comment"># 3.返回一个应答</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'%s修改密码为:%s'</span>%(username,pwd))</span><br></pre></td></tr></table></figure>
<h4 id="4）app2-urls-py"><a href="#4）app2-urls-py" class="headerlink" title="4）app2/urls.py"></a>4）app2/urls.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">'login/'</span>,views.login),<span class="comment">#登录页</span></span><br><span class="line">   path(<span class="string">'login_check'</span>,views.login_check),<span class="comment">#登录检测</span></span><br><span class="line">   </span><br><span class="line">   path(<span class="string">'change_pwd/'</span>, views.change_pwd), <span class="comment"># 修改密码页面显示</span></span><br><span class="line">   path(<span class="string">'change_pwd_action/'</span>, views.change_pwd_action), <span class="comment"># 修改密码处理</span></span><br></pre></td></tr></table></figure>
<h4 id="5-templates-login-html-ajax登录技术"><a href="#5-templates-login-html-ajax登录技术" class="headerlink" title="5 ) templates/login.html(ajax登录技术)"></a><font color='red'>5 ) templates/login.html(ajax登录技术)</font></h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"zh"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;!-- 【0】引入jquery --&gt;</span><br><span class="line">    &lt;script src="/static/js/jquery-1.12.4.min.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;title&gt;登录页面&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    // 写ajax处理函数</span><br><span class="line">    $(function () &#123;</span><br><span class="line">        $(<span class="string">'#btnLogin'</span>).click(function () &#123;</span><br><span class="line">            //<span class="number">1.</span>获取用户名、密码、是否记住用户名</span><br><span class="line">            username=$(<span class="string">'#username'</span>).val()</span><br><span class="line">            password=$(<span class="string">'#password'</span>).val()</span><br><span class="line">            remember=$(<span class="string">'#remember'</span>).val() //【<span class="number">2</span>】是否记住用户名</span><br><span class="line">            //<span class="number">2.</span>发起ajax--post(username,password)请求验证，地址：/login_check</span><br><span class="line">            $.ajax(&#123;</span><br><span class="line">                <span class="string">'url'</span>:<span class="string">'/login_check'</span>,//验证地址</span><br><span class="line">                <span class="string">'type'</span>:<span class="string">'post'</span>,//请求类型</span><br><span class="line">                <span class="string">'data'</span>:&#123;<span class="string">'username'</span>:username,<span class="string">'password'</span>:password,<span class="string">'remember'</span>:remember&#125;,//【<span class="number">3</span>】发送数据，加上remember</span><br><span class="line">                <span class="string">'dataType'</span>:<span class="string">'json'</span>,//希望返回数据类型</span><br><span class="line">            &#125;).success(function(data)&#123;</span><br><span class="line">                //成功返回&#123;<span class="string">'res'</span>:<span class="number">1</span>&#125;,失败&#123;<span class="string">'res'</span>:<span class="number">0</span>&#125;</span><br><span class="line">                <span class="keyword">if</span>(data.res===<span class="number">0</span>)&#123;</span><br><span class="line">                    $(<span class="string">'#msg'</span>).show().html(<span class="string">'用户名或密码错误请重试！'</span>)//登录失败则显示msg，并在里写入信息</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;//成功跳转到books页面</span><br><span class="line">                    location.href=<span class="string">'/change_pwd'</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    /* 信息提示样式 */</span><br><span class="line"><span class="comment">#msg&#123;</span></span><br><span class="line">    display: none;</span><br><span class="line">    color:red;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;!-- 原form删除，input的name变id，方便jquery操作 --&gt;</span><br><span class="line">    &lt;!-- 【4】把views页的login()函数传过来的用户名，密码赋值给对应处 --&gt;</span><br><span class="line">    用户名:&lt;input type=<span class="string">"text"</span> id=<span class="string">"username"</span> value=<span class="string">"&#123;&#123;username&#125;&#125;"</span>&gt;&lt;br/&gt;</span><br><span class="line">    密码:&lt;input type=<span class="string">"password"</span> id=<span class="string">"password"</span> value=<span class="string">"&#123;&#123;password&#125;&#125;"</span>&gt;&lt;br/&gt;</span><br><span class="line">    &lt;!-- 加入一个信息提示框，用于密码等错误提示 --&gt;</span><br><span class="line">    &lt;div id="msg"&gt;&lt;/div&gt;</span><br><span class="line">    &lt;!-- 【1】记住用户名，设置cookie用，如果勾选则其value=on --&gt;</span><br><span class="line">    &lt;input type=<span class="string">"checkbox"</span> id=<span class="string">"remember"</span>&gt;记住用户名&lt;br/&gt;</span><br><span class="line">    &lt;!-- 按钮type改button,加一个id方便jquery操作 --&gt;</span><br><span class="line">    &lt;input type=<span class="string">"button"</span> id=<span class="string">"btnLogin"</span> value=<span class="string">"登录"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h4 id="6）效果：http-127-0-0-1-8000-login"><a href="#6）效果：http-127-0-0-1-8000-login" class="headerlink" title="6）效果：http://127.0.0.1:8000/login/"></a>6）效果：<a href="http://127.0.0.1:8000/login/" target="_blank" rel="noopener">http://127.0.0.1:8000/login/</a></h4><h5 id="用户名或密码错误："><a href="#用户名或密码错误：" class="headerlink" title="用户名或密码错误："></a>用户名或密码错误：</h5><img src="https://img-blog.csdnimg.cn/20200112103417716.png" alt="在这里插入图片描述"><h5 id="不登录直接访问修改密码页面：http-127-0-0-1-8000-change-pwd-跳回登录页"><a href="#不登录直接访问修改密码页面：http-127-0-0-1-8000-change-pwd-跳回登录页" class="headerlink" title="不登录直接访问修改密码页面：http://127.0.0.1:8000/change_pwd 跳回登录页"></a>不登录直接访问修改密码页面：<a href="http://127.0.0.1:8000/change_pwd" target="_blank" rel="noopener">http://127.0.0.1:8000/change_pwd</a> 跳回登录页</h5><h5 id="u-p正确（jim-123）跳转到：http-127-0-0-1-8000-change-pwd"><a href="#u-p正确（jim-123）跳转到：http-127-0-0-1-8000-change-pwd" class="headerlink" title="u/p正确（jim,123）跳转到：http://127.0.0.1:8000/change_pwd"></a>u/p正确（jim,123）跳转到：<a href="http://127.0.0.1:8000/change_pwd" target="_blank" rel="noopener">http://127.0.0.1:8000/change_pwd</a></h5><img src="https://img-blog.csdnimg.cn/20200112103710743.png" alt="在这里插入图片描述"><br>然后提示：jim修改密码为:456<h4 id="7）通过第3方网站修改密码具体操作过程如下："><a href="#7）通过第3方网站修改密码具体操作过程如下：" class="headerlink" title="7）通过第3方网站修改密码具体操作过程如下："></a>7）通过第3方网站修改密码具体操作过程如下：</h4></li>
<li>首先查看访问服务器的局域网IP及公网IP<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /all</span><br><span class="line">找到：</span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.4</span></span><br><span class="line"></span><br><span class="line">公网直接百度IP，查看即可</span><br></pre></td></tr></table></figure></li>
<li>创建服务，以下操作2选1<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">如果在局域网创建服务：</span><br><span class="line">py manage.py runserver <span class="number">192.168</span><span class="number">.1</span><span class="number">.4</span>:<span class="number">8000</span></span><br><span class="line"></span><br><span class="line">如果在【虚拟机】或【真正服务器】创建服务：</span><br><span class="line">py manage.py runserver 公网IP:<span class="number">8000</span></span><br></pre></td></tr></table></figure></li>
<li>配置settings.py<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DEBUG = <span class="literal">False</span> <span class="comment">#True</span></span><br><span class="line">ALLOWED_HOSTS = [<span class="string">'*'</span>]</span><br></pre></td></tr></table></figure></li>
<li>在局域网另一台电脑访问：192.168.1.4:8000/login 即可访问网站,输入（jim,123）登录成功。</li>
<li>【创建伪造页】在访问电脑自建一个页面如下：<br>【csrf-test.html】<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>修改密码页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"http://192.168.1.4:8000/change_pwd_action/"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"pwd"</span> <span class="attr">value</span>=<span class="string">'789'</span>&gt;</span><span class="comment">&lt;!--【1】用了隐藏input，页面只能看到一个按钮，并给新密码定为789--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"点我有惊喜！"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>打开第5步的页面，点按键即可修改成功对应网站密码：<br><img src="https://img-blog.csdnimg.cn/20200112111619881.png" alt="在这里插入图片描述"></li>
<li>跨站伪造post请求修改用户密码成功！<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jim修改密码为:789</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="1-1-1-django防止csrf的方式："><a href="#1-1-1-django防止csrf的方式：" class="headerlink" title="1.1.1 django防止csrf的方式："></a><font color='red'>1.1.1 django防止csrf的方式：</font></h3><h4 id="1-默认打开csrf中间件（project2-settings-py）。"><a href="#1-默认打开csrf中间件（project2-settings-py）。" class="headerlink" title="1) 默认打开csrf中间件（project2/settings.py）。"></a>1) 默认打开csrf中间件（project2/settings.py）。</h4><p>【1】django默认打开csrf防护，它只对post提交有效</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">'django.middleware.security.SecurityMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.sessions.middleware.SessionMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.common.CommonMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.csrf.CsrfViewMiddleware'</span>, <span class="comment">#【1】django默认打开csrf防护，它只对post提交有效</span></span><br><span class="line">    <span class="string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages.middleware.MessageMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="2-表单post提交数据时加上-csrf-token-标签"><a href="#2-表单post提交数据时加上-csrf-token-标签" class="headerlink" title="2) 表单post提交数据时加上{ % csrf_token % }标签"></a>2) 表单post提交数据时加上<code>{ % csrf_token % }</code>标签</h4><p>（对应模板本例：change_pwd.html）。<br>【注意】：需要有post页面提交的页面必须加上<code>{ % csrf_token % }</code>，否则即使本站页面也会访问失败。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;修改密码页面&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form method=<span class="string">"post"</span> action=<span class="string">"/change_pwd_action/"</span>&gt;</span><br><span class="line">    &#123;% csrf_token %&#125;&lt;!--【1】本页面要有post提交，所以加上--&gt;</span><br><span class="line">    新密码:&lt;input type=<span class="string">"password"</span> name=<span class="string">"pwd"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> value=<span class="string">"确认修改"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h4 id="3）templates-app2-login-html是Ajax页，所以不能用普通写法"><a href="#3）templates-app2-login-html是Ajax页，所以不能用普通写法" class="headerlink" title="3）templates/app2/login.html是Ajax页，所以不能用普通写法"></a><font color='red'>3）templates/app2/login.html是Ajax页，所以不能用普通写法</font></h4><p>【参考】：<a href="https://code.ziqiangxuetang.com/django/django-csrf.html?bd_source_light=4317393" target="_blank" rel="noopener">https://code.ziqiangxuetang.com/django/django-csrf.html?bd_source_light=4317393</a></p>
<ol>
<li>在视图中使用 render（而不要使用 render_to_response）</li>
<li>在ajax中加：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$.ajaxPost(&#123;</span><br><span class="line">    data: &#123;<span class="attr">csrfmiddlewaretoken</span>: <span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span> &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li>详细代码：【4】csrf防护<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"zh"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;!-- 【0】引入jquery --&gt;</span><br><span class="line">    &lt;script src="/static/js/jquery-1.12.4.min.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;title&gt;登录页面&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    // 写ajax处理函数</span><br><span class="line">    $(function () &#123;</span><br><span class="line">        $(<span class="string">'#btnLogin'</span>).click(function () &#123;</span><br><span class="line">            //<span class="number">1.</span>获取用户名、密码、是否记住用户名</span><br><span class="line">            username=$(<span class="string">'#username'</span>).val()</span><br><span class="line">            password=$(<span class="string">'#password'</span>).val()</span><br><span class="line">            remember=$(<span class="string">'#remember'</span>).val() //【<span class="number">2</span>】是否记住用户名</span><br><span class="line">            //<span class="number">2.</span>发起ajax--post(username,password)请求验证，地址：/login_check</span><br><span class="line">            $.ajax(&#123;</span><br><span class="line">                <span class="string">'url'</span>:<span class="string">'/login_check'</span>,//验证地址</span><br><span class="line">                <span class="string">'type'</span>:<span class="string">'post'</span>,//请求类型</span><br><span class="line">                <span class="string">'data'</span>:&#123;//【<span class="number">3</span>】发送数据，加上remember</span><br><span class="line">                    <span class="string">'username'</span>:username,</span><br><span class="line">                    <span class="string">'password'</span>:password,</span><br><span class="line">                    <span class="string">'remember'</span>:remember,</span><br><span class="line">                    csrfmiddlewaretoken: <span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span>,//【<span class="number">4</span>】csrf防护</span><br><span class="line">                    &#125;,</span><br><span class="line">                <span class="string">'dataType'</span>:<span class="string">'json'</span>,//希望返回数据类型</span><br><span class="line">            &#125;).success(function(data)&#123;</span><br><span class="line">                //成功返回&#123;<span class="string">'res'</span>:<span class="number">1</span>&#125;,失败&#123;<span class="string">'res'</span>:<span class="number">0</span>&#125;</span><br><span class="line">                <span class="keyword">if</span>(data.res===<span class="number">0</span>)&#123;</span><br><span class="line">                    $(<span class="string">'#msg'</span>).show().html(<span class="string">'用户名或密码错误请重试！'</span>)//登录失败则显示msg，并在里写入信息</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;//成功跳转到books页面</span><br><span class="line">                    location.href=<span class="string">'/change_pwd'</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    /* 信息提示样式 */</span><br><span class="line"><span class="comment">#msg&#123;</span></span><br><span class="line">    display: none;</span><br><span class="line">    color:red;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;!-- 原form删除，input的name变id，方便jquery操作 --&gt;</span><br><span class="line">    &lt;!-- 【4】把views页的login()函数传过来的用户名，密码赋值给对应处 --&gt;</span><br><span class="line">    用户名:&lt;input type=<span class="string">"text"</span> id=<span class="string">"username"</span> value=<span class="string">"&#123;&#123;username&#125;&#125;"</span>&gt;&lt;br/&gt;</span><br><span class="line">    密码:&lt;input type=<span class="string">"password"</span> id=<span class="string">"password"</span> value=<span class="string">"&#123;&#123;password&#125;&#125;"</span>&gt;&lt;br/&gt;</span><br><span class="line">    &lt;!-- 加入一个信息提示框，用于密码等错误提示 --&gt;</span><br><span class="line">    &lt;div id="msg"&gt;&lt;/div&gt;</span><br><span class="line">    &lt;!-- 【1】记住用户名，设置cookie用，如果勾选则其value=on --&gt;</span><br><span class="line">    &lt;input type=<span class="string">"checkbox"</span> id=<span class="string">"remember"</span>&gt;记住用户名&lt;br/&gt;</span><br><span class="line">    &lt;!-- 按钮type改button,加一个id方便jquery操作 --&gt;</span><br><span class="line">    &lt;input type=<span class="string">"button"</span> id=<span class="string">"btnLogin"</span> value=<span class="string">"登录"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="再跨站修改（7-6）："><a href="#再跨站修改（7-6）：" class="headerlink" title="再跨站修改（7.6）："></a>再跨站修改（7.6）：</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;p style=<span class="string">"background-color:rgb(255, 255, 204)"</span>&gt;</span><br><span class="line">禁止访问 (<span class="number">403</span>)</span><br><span class="line">CSRF验证失败. 请求被中断.</span><br><span class="line">您看到此消息是由于该站点在提交表单时需要一个CSRF cookie。此项是出于安全考虑，以确保您的浏览器没有被第三方劫持。</span><br><span class="line">If you have configured your browser to disable cookies, please re-enable them, at least for this site, or for “same-origin” requests.&lt;/p&gt;</span><br></pre></td></tr></table></figure>


<h3 id="1-1-2-防御原理"><a href="#1-1-2-防御原理" class="headerlink" title="1.1.2 防御原理:"></a>1.1.2 防御原理:</h3><p>1) 渲染模板文件时在页面生成一个名字叫做csrfmiddlewaretoken的隐藏域。<br>在网站右键查看源码，可看到这个隐藏域：name=csrfmiddlewaretoken 的input</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form method=<span class="string">"post"</span> action=<span class="string">"/change_pwd_action/"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"csrfmiddlewaretoken"</span> value=<span class="string">"O6lfnrybooqSP9Je0bZyCOr8qGObvK0jgzV7fMUW259X117OkpAm8OjtCsadu9tk"</span>&gt;</span><br><span class="line">    新密码:&lt;input type=<span class="string">"password"</span> name=<span class="string">"pwd"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> value=<span class="string">"确认修改"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>把上例的隐藏域的value传给服务器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"csrfmiddlewaretoken"</span> value=<span class="string">"O6lfnrybooqSP9Je0bZyCOr8qGObvK0jgzV7fMUW259X117OkpAm8OjtCsadu9tk"</span>&gt;</span><br></pre></td></tr></table></figure>
<p>2) 服务器同时交给浏览器保存一个名字为csrftoken的cookie信息。<br>3) 提交表单时，两个值都会发给服务器，服务器进行比对，如果一样，则csrf验证通过，否则失败。</p>
<h1 id="二、验证码"><a href="#二、验证码" class="headerlink" title="二、验证码"></a>二、验证码</h1><ul>
<li>在用户注册、登录页面，为了防止暴力请求(穷举法破解用户名密码、自动注册大量账号等)，可以加入验证码功能，如果验证码错误，则不需要继续处理，可以减轻业务服务器、数据库服务器的压力。</li>
<li>【其它生成验证码参考】：<a href="https://blog.csdn.net/ding_312/article/details/82258442" target="_blank" rel="noopener">https://blog.csdn.net/ding_312/article/details/82258442</a><h3 id="1）生成验证码函数-app2-views-py"><a href="#1）生成验证码函数-app2-views-py" class="headerlink" title="1）生成验证码函数 app2/views.py"></a><font color='red'>1）生成验证码函数 app2/views.py</font></h3>【1】存入session，用于做进一步验证<br>【2】将图片保存在内存中，文件类型为png<br>【3】将内存中的图片数据返回给客户端，MIME类型为图片png<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFont</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"><span class="comment"># /verify_code</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_code</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 引入随机函数模块</span></span><br><span class="line">    <span class="keyword">import</span> random</span><br><span class="line">    <span class="comment"># 定义变量，用于画面的背景色、宽、高 RGB</span></span><br><span class="line">    bgcolor = (random.randrange(<span class="number">20</span>, <span class="number">100</span>), random.randrange(<span class="number">20</span>, <span class="number">100</span>), <span class="number">255</span>)</span><br><span class="line">    width = <span class="number">100</span></span><br><span class="line">    height = <span class="number">25</span></span><br><span class="line">    <span class="comment"># 创建画面对象</span></span><br><span class="line">    im = Image.new(<span class="string">'RGB'</span>, (width, height), bgcolor)</span><br><span class="line">    <span class="comment"># 创建画笔对象</span></span><br><span class="line">    draw = ImageDraw.Draw(im)</span><br><span class="line">    <span class="comment"># 调用画笔的point()函数绘制噪点</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">100</span>):</span><br><span class="line">        xy = (random.randrange(<span class="number">0</span>, width), random.randrange(<span class="number">0</span>, height))</span><br><span class="line">        fill = (random.randrange(<span class="number">0</span>, <span class="number">255</span>), <span class="number">255</span>, random.randrange(<span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line">        draw.point(xy, fill=fill)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义验证码的备选值</span></span><br><span class="line">    str1 = <span class="string">'ABCD123EFGHIJK456LMNOPQRS789TUVWXYZ0'</span> <span class="comment">#qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM0123456789</span></span><br><span class="line">    <span class="comment"># 随机选取4个值作为验证码</span></span><br><span class="line">    rand_str = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">4</span>):</span><br><span class="line">        rand_str += str1[random.randrange(<span class="number">0</span>, len(str1))]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造字体对象，ubuntu的字体路径为“/usr/share/fonts/truetype/freefont”</span></span><br><span class="line">    font = ImageFont.truetype(<span class="string">'AdobeFanHeitiStd-Bold.otf'</span>, <span class="number">23</span>)</span><br><span class="line">    <span class="comment"># 构造字体颜色</span></span><br><span class="line">    fontcolor = (<span class="number">255</span>, random.randrange(<span class="number">0</span>, <span class="number">255</span>), random.randrange(<span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line">    <span class="comment"># 绘制4个字</span></span><br><span class="line">    draw.text((<span class="number">5</span>, <span class="number">2</span>), rand_str[<span class="number">0</span>], font=font, fill=fontcolor)</span><br><span class="line">    draw.text((<span class="number">25</span>, <span class="number">2</span>), rand_str[<span class="number">1</span>], font=font, fill=fontcolor)</span><br><span class="line">    draw.text((<span class="number">50</span>, <span class="number">2</span>), rand_str[<span class="number">2</span>], font=font, fill=fontcolor)</span><br><span class="line">    draw.text((<span class="number">75</span>, <span class="number">2</span>), rand_str[<span class="number">3</span>], font=font, fill=fontcolor)</span><br><span class="line">    <span class="comment"># 释放画笔</span></span><br><span class="line">    <span class="keyword">del</span> draw</span><br><span class="line">    <span class="comment"># 【1】存入session，用于做进一步验证</span></span><br><span class="line">    request.session[<span class="string">'verifycode'</span>] = rand_str</span><br><span class="line">    <span class="comment"># 内存文件操作</span></span><br><span class="line">    buf = io.BytesIO()</span><br><span class="line">    <span class="comment"># 【2】将图片保存在内存中，文件类型为png</span></span><br><span class="line">    im.save(buf, <span class="string">'png'</span>)</span><br><span class="line">    <span class="comment"># 【3】将内存中的图片数据返回给客户端，MIME类型为图片png</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(buf.getvalue(), <span class="string">'image/png'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="2）app2-urls-py"><a href="#2）app2-urls-py" class="headerlink" title="2）app2/urls.py"></a>2）app2/urls.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">'verify_code'</span>,views.verify_code),<span class="comment">#生成验证码</span></span><br></pre></td></tr></table></figure>
<h3 id="3）效果：http-127-0-0-1-8000-verify-code"><a href="#3）效果：http-127-0-0-1-8000-verify-code" class="headerlink" title="3）效果：http://127.0.0.1:8000/verify_code"></a>3）效果：<a href="http://127.0.0.1:8000/verify_code" target="_blank" rel="noopener">http://127.0.0.1:8000/verify_code</a></h3><img src="https://img-blog.csdnimg.cn/20200112155943850.png" alt="在这里插入图片描述"><h3 id="4）在templates-app2-login-html加验证码（这次用表单提交）"><a href="#4）在templates-app2-login-html加验证码（这次用表单提交）" class="headerlink" title="4）在templates/app2/login.html加验证码（这次用表单提交）"></a>4）在templates/app2/login.html加验证码（这次用表单提交）</h3>【1】添加验证码,直接把验证码地址写在src内<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;登录页面&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form method=<span class="string">"post"</span> action=<span class="string">"/login_check"</span>&gt;</span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line">    用户名:&lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span> value=<span class="string">"&#123;&#123; username &#125;&#125;"</span>&gt;&lt;br/&gt;</span><br><span class="line">    密码:&lt;input type=<span class="string">"password"</span> name=<span class="string">"password"</span>&gt;&lt;br/&gt;</span><br><span class="line">    &lt;input type=<span class="string">"checkbox"</span> name=<span class="string">"remember"</span>&gt;记住用户名&lt;br/&gt;</span><br><span class="line">    &lt;!--【1】添加验证码,直接把地址写在src内--&gt;</span><br><span class="line">    &lt;img src=<span class="string">"/verify_code"</span>&gt;&lt;br/&gt;</span><br><span class="line">    &lt;input type=<span class="string">"text"</span> name=<span class="string">"vcode"</span>&gt;输入验证码&lt;br/&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> value=<span class="string">"登录"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="5）app2-views-py验证函数修改"><a href="#5）app2-views-py验证函数修改" class="headerlink" title="5）app2/views.py验证函数修改"></a>5）app2/views.py验证函数修改</h3>【1】获取用户输入验证码<br>【2】获取session中保存的验证码（在第1步）<br>【3】进行验证码校验，如果验证码输入不对直接返回登录页面，下面的密码验证就不再进行操作了<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''登录页'''</span></span><br><span class="line">    <span class="comment"># 判断用户是否登录，用户已登录, 直接跳转到图书列表</span></span><br><span class="line">    <span class="keyword">if</span> request.session.has_key(<span class="string">'islogin'</span>):</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'/change_pwd/'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment">#如果用户名密码已经在cookie中，则取到它，并做为参数返回给渲染页面</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'username'</span> <span class="keyword">in</span> request.COOKIES:</span><br><span class="line">            <span class="comment">#获取cookie中的用户名、密码</span></span><br><span class="line">            username=request.COOKIES[<span class="string">'username'</span>]</span><br><span class="line">            <span class="comment">#password=request.COOKIES['password']</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            username=<span class="string">''</span></span><br><span class="line">            <span class="comment">#password=''</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'app2/login.html'</span>,&#123;<span class="string">'username'</span>:username&#125;) <span class="comment">#,'password':password</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_check</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''登录校验'''</span></span><br><span class="line">    <span class="comment">#1.获取用户名密码</span></span><br><span class="line">    username=request.POST.get(<span class="string">'username'</span>)</span><br><span class="line">    password=request.POST.get(<span class="string">'password'</span>)</span><br><span class="line">    remember=request.POST.get(<span class="string">'remember'</span>) <span class="comment">#接收remeber</span></span><br><span class="line">    </span><br><span class="line">    vcode1 = request.POST.get(<span class="string">'vcode'</span>) <span class="comment"># 【1】获取用户输入验证码</span></span><br><span class="line">    vcode2 = request.session.get(<span class="string">'verifycode'</span>) <span class="comment"># 【2】获取session中保存的验证码</span></span><br><span class="line">    <span class="comment"># 【3】进行验证码校验，如果验证码输入不对直接返回登录页面，下面的密码验证就不再进行操作了</span></span><br><span class="line">    <span class="keyword">if</span> vcode1 != vcode2:</span><br><span class="line">        <span class="comment"># 验证码错误</span></span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'/login'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#2.进行校验，并返回json数据</span></span><br><span class="line">    <span class="keyword">if</span> username==<span class="string">'jim'</span> <span class="keyword">and</span> password==<span class="string">'123'</span>:</span><br><span class="line">        <span class="comment">#return redirect('/books')</span></span><br><span class="line">        response = JsonResponse(&#123;<span class="string">'res'</span>:<span class="number">1</span>,<span class="string">'msg'</span>:<span class="string">'login success!'</span>&#125;) <span class="comment">#密码正确，登录成功，返回1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#如果remember==on，则把用户名,密码设置cookie到cookie</span></span><br><span class="line">        <span class="keyword">if</span> remember==<span class="string">'on'</span>:</span><br><span class="line">            response.set_cookie(<span class="string">'username'</span>,username,max_age=<span class="number">7</span>*<span class="number">24</span>*<span class="number">3600</span>)</span><br><span class="line">            <span class="comment">#response.set_cookie('password',password,max_age=7*24*3600)</span></span><br><span class="line">            <span class="comment"># 记住用户登录状态把用户名设置到session</span></span><br><span class="line">            request.session[<span class="string">'username'</span>] = username</span><br><span class="line">            <span class="comment"># 返回应答</span></span><br><span class="line">            <span class="comment"># 如果用户勾选了remember的条件下，设置session,记住用户登录状态</span></span><br><span class="line">            request.session[<span class="string">'islogin'</span>] = <span class="literal">True</span> <span class="comment"># 只有session中有islogin,就认为用户已登录</span></span><br><span class="line">        <span class="keyword">return</span> response <span class="comment">#不要忘记返回response</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment">#return redirect('/login')</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(&#123;<span class="string">'res'</span>:<span class="number">0</span>,<span class="string">'msg'</span>:<span class="string">'login faild'</span>&#125;) <span class="comment">#密码错误返回0</span></span><br></pre></td></tr></table></figure>
<h3 id="6）效果：http-127-0-0-1-8000-login-1"><a href="#6）效果：http-127-0-0-1-8000-login-1" class="headerlink" title="6）效果：http://127.0.0.1:8000/login/"></a>6）效果：<a href="http://127.0.0.1:8000/login/" target="_blank" rel="noopener">http://127.0.0.1:8000/login/</a></h3><img src="https://img-blog.csdnimg.cn/20200112163623257.png" alt="在这里插入图片描述"></li>
</ul>
<ol>
<li>用户名、密码、验证码、都正确返回：1 –登录成功</li>
<li>有一个错误返回 ：0– 登录失败</li>
</ol>
<h1 id="三、反向解析"><a href="#三、反向解析" class="headerlink" title="三、反向解析"></a>三、反向解析</h1><ol>
<li>当某一个url配置的地址发生变化时，页面上使用反向解析生成地址的位置不需要发生变化。</li>
<li>根据url 正则表达式的配置动态的生成url。</li>
<li>在项目urls中包含具体应用的urls文件时指定namespace;</li>
</ol>
<h3 id="1）project2-urls-py配置namespace【重点1】"><a href="#1）project2-urls-py配置namespace【重点1】" class="headerlink" title="1）project2/urls.py配置namespace【重点1】"></a>1）project2/urls.py配置namespace【重点1】</h3><h4 id="1-1）Django2-0之后写法"><a href="#1-1）Django2-0之后写法" class="headerlink" title="1-1）Django2.0之后写法"></a><font color='red'>1-1）Django2.0之后写法</font></h4><p>【参考】<a href="https://blog.csdn.net/weixin_43883625/article/details/100545439" target="_blank" rel="noopener">https://blog.csdn.net/weixin_43883625/article/details/100545439</a><br>【1】配置namespace，注意写法：<code>re_path(r&#39;^&#39;,include((&#39;app2.urls&#39;,&#39;booktest&#39;),namespace=&quot;booktest&quot;))</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,include,re_path</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'admin/'</span>, admin.site.urls),</span><br><span class="line">    <span class="comment"># 【1】配置namespace，注意写法：include(('app2.urls','booktest'),namespace="booktest")</span></span><br><span class="line">    re_path(<span class="string">r'^'</span>,include((<span class="string">'app2.urls'</span>,<span class="string">'booktest'</span>),namespace=<span class="string">"booktest"</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="1-2）Django2-0之前写法-project2-urls-py配置namespace"><a href="#1-2）Django2-0之前写法-project2-urls-py配置namespace" class="headerlink" title="1-2）Django2.0之前写法:project2/urls.py配置namespace"></a>1-2）Django2.0之前写法:project2/urls.py配置namespace</h4><p> 【1】2.0之前写法：<code>url(r&#39;^&#39;, include(&#39;app2.urls&#39;, namespace=&#39;booktest&#39;)),</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">from django.conf.urls import include, url</span></span><br><span class="line"><span class="string">from django.contrib import admin</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">urlpatterns = [</span></span><br><span class="line"><span class="string">    url(r'^admin/', include(admin.site.urls)),</span></span><br><span class="line"><span class="string">    #【1】2.0之前写法：include('app2.urls', namespace='booktest')</span></span><br><span class="line"><span class="string">    url(r'^', include('app2.urls', namespace='booktest')),</span></span><br><span class="line"><span class="string">]</span></span><br></pre></td></tr></table></figure>
<h3 id="2）app2-urls-py配置-【重点2】"><a href="#2）app2-urls-py配置-【重点2】" class="headerlink" title="2）app2/urls.py配置 【重点2】"></a>2）app2/urls.py配置 【重点2】</h3><p>【1】 配置name反向解析配置<code>path(&#39;index2/&#39;, views.index, name=&#39;index&#39;)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,re_path</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">	<span class="comment"># 【1】 配置name反向解析配置path('index2/', views.index, name='index')</span></span><br><span class="line">    path(<span class="string">'index/'</span>, views.index, name=<span class="string">'index'</span>),</span><br><span class="line">    path(<span class="string">'url_reverse/'</span>, views.url_reverse),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>


<h3 id="3）app2-views-py写url-reverse函数"><a href="#3）app2-views-py写url-reverse函数" class="headerlink" title="3）app2/views.py写url_reverse函数"></a>3）app2/views.py写url_reverse函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /url_reverse</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">url_reverse</span> <span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'app2/url_reverse.html'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="4）模板引用templates-app2-url-reverse-html【重点3】"><a href="#4）模板引用templates-app2-url-reverse-html【重点3】" class="headerlink" title="4）模板引用templates/app2/url_reverse.html【重点3】"></a>4）模板引用templates/app2/url_reverse.html【重点3】</h3><p>【1】反向解析模板写法 <code>&lt;a href=&quot;{ % url &#39;booktest:index&#39; % }&quot;&gt;反向解析&lt;/a&gt;</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;反向解析&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;a href="/index"&gt;写死地址&lt;/a&gt;</span><br><span class="line">&lt;br/&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--【1】反向解析模板写法--&gt;</span><br><span class="line">&lt;a href="&#123;% url 'booktest:index' %&#125;"&gt;反向解析&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="5）效果：http-127-0-0-1-8000-url-reverse"><a href="#5）效果：http-127-0-0-1-8000-url-reverse" class="headerlink" title="5）效果：http://127.0.0.1:8000/url_reverse/"></a>5）效果：<a href="http://127.0.0.1:8000/url_reverse/" target="_blank" rel="noopener">http://127.0.0.1:8000/url_reverse/</a></h3><p><a href="/index">写死地址</a> <a href="http://127.0.0.1:8000/index" target="_blank" rel="noopener">http://127.0.0.1:8000/index</a><br><a href="{ % url 'booktest:index' % }">反向解析</a> <a href="http://127.0.0.1:8000/index" target="_blank" rel="noopener">http://127.0.0.1:8000/index</a></p>
<ol>
<li>当2步的<code>path(&#39;index/&#39;, views.index, name=&#39;index&#39;)</code> 变 <code>path(&#39;index2/&#39;, views.index, name=&#39;index&#39;)</code>时。</li>
<li>写死地址的连接不会变，反向解析会自动变为：<a href="http://127.0.0.1:8000/index2" target="_blank" rel="noopener">http://127.0.0.1:8000/index2</a></li>
</ol>
<h2 id="3-2-反向解析-动态传参"><a href="#3-2-反向解析-动态传参" class="headerlink" title="3.2 反向解析+动态传参"></a>3.2 反向解析+动态传参</h2><h3 id="1）app2-views-py"><a href="#1）app2-views-py" class="headerlink" title="1）app2/views.py"></a>1）app2/views.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render,redirect</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse,JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="comment"># show_args</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_args</span><span class="params">(request, a, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(a+<span class="string">':'</span>+b)</span><br><span class="line"></span><br><span class="line"><span class="comment"># show_kwargs</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_kwargs</span><span class="params">(request, c, d)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(c+<span class="string">':'</span>+d)</span><br></pre></td></tr></table></figure>

<h3 id="2）【重点1：反向解析-传参配置url】app2-urls-py"><a href="#2）【重点1：反向解析-传参配置url】app2-urls-py" class="headerlink" title="2）【重点1：反向解析+传参配置url】app2/urls.py"></a>2）<font color='red'>【重点1：反向解析+传参配置url】app2/urls.py</font></h3><p>【1】反向解析+分组传参数<br>【2】反向解析+字典传参数（以下两种写法都可）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,re_path</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    re_path(<span class="string">r'^show_args/(\d+)/(\d+)'</span>, views.show_args,name=<span class="string">'show_args'</span>),<span class="comment">#【1】反向解析+分组传参数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#【2】反向解析+字典传参数（以下两种写法都可）</span></span><br><span class="line">    <span class="comment">#path(r'show_kwargs/&lt;str:c&gt;/&lt;str:d&gt;',views.show_kwargs,name='show_kwargs'),</span></span><br><span class="line">    path(<span class="string">r'show_kwargs/&lt;c&gt;/&lt;d&gt;'</span>,views.show_kwargs,name=<span class="string">'show_kwargs'</span>),</span><br><span class="line">  ]</span><br></pre></td></tr></table></figure>

<h3 id="3）【重点2：反向解析-传参-模板写法】templates-app2-url-reverse-html"><a href="#3）【重点2：反向解析-传参-模板写法】templates-app2-url-reverse-html" class="headerlink" title="3）【重点2：反向解析+传参+模板写法】templates/app2/url_reverse.html"></a>3）<font color='red'>【重点2：反向解析+传参+模板写法】templates/app2/url_reverse.html</font></h3><p>【1】反向解析+分组传参：<code>href=&quot;{ % url &#39;booktest:show_args&#39; 1 2 % }&quot;</code><br>【2】反向解析+字典传参：<code>href=&quot;{ % url &#39;booktest:show_kwargs&#39; c=3 d=4 % }&quot;</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;反向解析&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;a href="/index"&gt;写死地址&lt;/a&gt;</span><br><span class="line">&lt;br/&gt;</span><br><span class="line">&lt;a href="&#123;% url 'booktest:index' %&#125;"&gt;反向解析&lt;/a&gt;</span><br><span class="line">&lt;hr/&gt;</span><br><span class="line"></span><br><span class="line">&lt;br/&gt;</span><br><span class="line">&lt;a href="/show_args/1/2"&gt;写死+分组传参：/show_args/1/2&lt;/a&gt;&lt;br/&gt;</span><br><span class="line"></span><br><span class="line">&lt;br/&gt;</span><br><span class="line">&lt;a href="&#123;% url 'booktest:show_args' 1 2 %&#125;"&gt;【1】反向解析+分组传参：/show_args/1/2&lt;/a&gt;&lt;br/&gt;</span><br><span class="line">&#123;% url <span class="string">'booktest:show_args'</span> <span class="number">1</span> <span class="number">2</span> %&#125;</span><br><span class="line">&lt;hr/&gt;</span><br><span class="line"></span><br><span class="line">&lt;br/&gt;</span><br><span class="line">&lt;a href="/show_kwargs/3/4"&gt;写死+字典传参：/show_kwargs/3/4&lt;/a&gt;&lt;br/&gt;</span><br><span class="line">&lt;br/&gt;</span><br><span class="line"></span><br><span class="line">&lt;a href="&#123;% url 'booktest:show_kwargs' c=3 d=4 %&#125;"&gt;【2】反向解析+字典传参：/show_kwargs/3/4&lt;/a&gt;&lt;br/&gt;</span><br><span class="line">&#123;% url <span class="string">'booktest:show_kwargs'</span> c=<span class="number">3</span> d=<span class="number">4</span> %&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="4）效果：http-127-0-0-1-8000-url-reverse"><a href="#4）效果：http-127-0-0-1-8000-url-reverse" class="headerlink" title="4）效果：http://127.0.0.1:8000/url_reverse/"></a>4）效果：<a href="http://127.0.0.1:8000/url_reverse/" target="_blank" rel="noopener">http://127.0.0.1:8000/url_reverse/</a></h3><p>【1】<a href="/show_args/1/2">写死+分组传参：/show_args/1/2</a><br>【2】<a href="{ % url 'booktest:show_args' 1 2 % }">反向解析+分组传参：/show_args/1/2</a><br>【3】<a href="/show_kwargs/3/4">写死+字典传参：/show_kwargs/3/4</a><br>【4】<a href="{ % url 'booktest:show_kwargs' c=3 d=4 % }">反向解析+字典传参：/show_kwargs/3/4</a></p>
<ul>
<li>当2)步的【show_args】变【show_args2】时，【2】【4】都可正确更新链接，【1】【2】不行<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    re_path(<span class="string">r'^show_args2/(\d+)/(\d+)'</span>, views.show_args,name=<span class="string">'show_args'</span>),<span class="comment">#【1】反向解析+分组传参数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#【2】反向解析+字典传参数（以下两种写法都可）</span></span><br><span class="line">    <span class="comment">#path(r'show_kwargs/&lt;str:c&gt;/&lt;str:d&gt;',views.show_kwargs,name='show_kwargs'),</span></span><br><span class="line">    path(<span class="string">r'show_kwargs2/&lt;c&gt;/&lt;d&gt;'</span>,views.show_kwargs,name=<span class="string">'show_kwargs'</span>),</span><br><span class="line">  ]</span><br></pre></td></tr></table></figure>
<h2 id="3-3-views函数里调用反向解析-传参"><a href="#3-3-views函数里调用反向解析-传参" class="headerlink" title="3.3 views函数里调用反向解析+传参"></a>3.3 views函数里调用反向解析+传参</h2><h3 id="1）app2-views-py【重点1】"><a href="#1）app2-views-py【重点1】" class="headerlink" title="1）app2/views.py【重点1】"></a>1）app2/views.py【重点1】</h3></li>
</ul>
<ol>
<li><code>redirect(&#39;/index&#39;)</code></li>
<li><code>reverse(&#39;booktest:index&#39;)</code></li>
<li><code>reverse(&#39;booktest:show_args&#39;, args=(1,2))</code></li>
<li><code>reverse(&#39;booktest:show_kwargs&#39;, kwargs={&#39;c&#39;:3, &#39;d&#39;:4})</code></li>
<li>记得返回<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from django.core.urlresolvers import reverse #【0-1】2.0之前导入reverse</span></span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse <span class="comment">#【0-2】2.0之后导入reverse</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /test_redirect</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_redirect</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 【0写死】重定向到/index</span></span><br><span class="line">    <span class="comment"># return redirect('/index')</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 【1反向解析】</span></span><br><span class="line">    <span class="comment"># url = reverse('booktest:index')</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 【2反向解析-分组传参】重定向到/show_args/1/2</span></span><br><span class="line">    url = reverse(<span class="string">'booktest:show_args'</span>, args=(<span class="number">1</span>,<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 【3反向解析-字典（关键字）传参】重定向到/show_kwargs/3/4</span></span><br><span class="line">    <span class="comment">#url = reverse('booktest:show_kwargs', kwargs=&#123;'c':3, 'd':4&#125;)</span></span><br><span class="line">    <span class="keyword">return</span> redirect(url)</span><br></pre></td></tr></table></figure>
<h3 id="2）app2-urls-py-1"><a href="#2）app2-urls-py-1" class="headerlink" title="2）app2/urls.py"></a>2）app2/urls.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">'test_redirect/'</span>,views.test_redirect),</span><br></pre></td></tr></table></figure>
<h3 id="3）其它配置见3-2（重点2）"><a href="#3）其它配置见3-2（重点2）" class="headerlink" title="3）其它配置见3.2（重点2）"></a>3）其它配置见3.2（重点2）</h3><h3 id="效果：把1）步的【0-3】多选1解除注释查看效果"><a href="#效果：把1）步的【0-3】多选1解除注释查看效果" class="headerlink" title="效果：把1）步的【0-3】多选1解除注释查看效果"></a>效果：把1）步的【0-3】多选1解除注释查看效果</h3>访问：<a href="http://127.0.0.1:8000/test_redirect" target="_blank" rel="noopener">http://127.0.0.1:8000/test_redirect</a> 会动态反向解析到对应的网址。3.2切换也没办法</li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/myblog/2020/01/12/Python%E4%B8%AD%E7%9A%84!%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0%E4%B8%8E!%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%82%E6%95%B0/" rel="prev" title="Python中的*可变参数与**关键字参数">
      <i class="fa fa-chevron-left"></i> Python中的*可变参数与**关键字参数
    </a></div>
      <div class="post-nav-item">
    <a href="/myblog/2020/01/14/Django%EF%BC%88%E5%8D%81%E4%B8%83%EF%BC%89%EF%BC%9A%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E3%80%81%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="next" title="Django（十七）：静态文件、中间件">
      Django（十七）：静态文件、中间件 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、csrf攻击"><span class="nav-number">1.</span> <span class="nav-text">一、csrf攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-csrf攻击（跨站请求伪造）"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 csrf攻击（跨站请求伪造）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#【csrf攻击改密码实例】（必须登录后才能操作）："><span class="nav-number">1.1.1.</span> <span class="nav-text">【csrf攻击改密码实例】（必须登录后才能操作）：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-project2-settings-py-注释掉csrf"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">1) project2&#x2F;settings.py 注释掉csrf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2）templates-change-pwd-html"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">2）templates&#x2F;change_pwd.html</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-app2-views-py【登录装饰器】"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">3) app2&#x2F;views.py【登录装饰器】</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4）app2-urls-py"><span class="nav-number">1.1.1.4.</span> <span class="nav-text">4）app2&#x2F;urls.py</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-templates-login-html-ajax登录技术"><span class="nav-number">1.1.1.5.</span> <span class="nav-text">5 ) templates&#x2F;login.html(ajax登录技术)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6）效果：http-127-0-0-1-8000-login"><span class="nav-number">1.1.1.6.</span> <span class="nav-text">6）效果：http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;login&#x2F;</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#用户名或密码错误："><span class="nav-number">1.1.1.6.1.</span> <span class="nav-text">用户名或密码错误：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#不登录直接访问修改密码页面：http-127-0-0-1-8000-change-pwd-跳回登录页"><span class="nav-number">1.1.1.6.2.</span> <span class="nav-text">不登录直接访问修改密码页面：http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;change_pwd 跳回登录页</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#u-p正确（jim-123）跳转到：http-127-0-0-1-8000-change-pwd"><span class="nav-number">1.1.1.6.3.</span> <span class="nav-text">u&#x2F;p正确（jim,123）跳转到：http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;change_pwd</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7）通过第3方网站修改密码具体操作过程如下："><span class="nav-number">1.1.1.7.</span> <span class="nav-text">7）通过第3方网站修改密码具体操作过程如下：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-1-django防止csrf的方式："><span class="nav-number">1.1.2.</span> <span class="nav-text">1.1.1 django防止csrf的方式：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-默认打开csrf中间件（project2-settings-py）。"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">1) 默认打开csrf中间件（project2&#x2F;settings.py）。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-表单post提交数据时加上-csrf-token-标签"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">2) 表单post提交数据时加上{ % csrf_token % }标签</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3）templates-app2-login-html是Ajax页，所以不能用普通写法"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">3）templates&#x2F;app2&#x2F;login.html是Ajax页，所以不能用普通写法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#再跨站修改（7-6）："><span class="nav-number">1.1.2.4.</span> <span class="nav-text">再跨站修改（7.6）：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-2-防御原理"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.1.2 防御原理:</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、验证码"><span class="nav-number">2.</span> <span class="nav-text">二、验证码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1）生成验证码函数-app2-views-py"><span class="nav-number">2.0.1.</span> <span class="nav-text">1）生成验证码函数 app2&#x2F;views.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2）app2-urls-py"><span class="nav-number">2.0.2.</span> <span class="nav-text">2）app2&#x2F;urls.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3）效果：http-127-0-0-1-8000-verify-code"><span class="nav-number">2.0.3.</span> <span class="nav-text">3）效果：http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;verify_code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4）在templates-app2-login-html加验证码（这次用表单提交）"><span class="nav-number">2.0.4.</span> <span class="nav-text">4）在templates&#x2F;app2&#x2F;login.html加验证码（这次用表单提交）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5）app2-views-py验证函数修改"><span class="nav-number">2.0.5.</span> <span class="nav-text">5）app2&#x2F;views.py验证函数修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6）效果：http-127-0-0-1-8000-login-1"><span class="nav-number">2.0.6.</span> <span class="nav-text">6）效果：http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;login&#x2F;</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、反向解析"><span class="nav-number">3.</span> <span class="nav-text">三、反向解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1）project2-urls-py配置namespace【重点1】"><span class="nav-number">3.0.1.</span> <span class="nav-text">1）project2&#x2F;urls.py配置namespace【重点1】</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1）Django2-0之后写法"><span class="nav-number">3.0.1.1.</span> <span class="nav-text">1-1）Django2.0之后写法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2）Django2-0之前写法-project2-urls-py配置namespace"><span class="nav-number">3.0.1.2.</span> <span class="nav-text">1-2）Django2.0之前写法:project2&#x2F;urls.py配置namespace</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2）app2-urls-py配置-【重点2】"><span class="nav-number">3.0.2.</span> <span class="nav-text">2）app2&#x2F;urls.py配置 【重点2】</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3）app2-views-py写url-reverse函数"><span class="nav-number">3.0.3.</span> <span class="nav-text">3）app2&#x2F;views.py写url_reverse函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4）模板引用templates-app2-url-reverse-html【重点3】"><span class="nav-number">3.0.4.</span> <span class="nav-text">4）模板引用templates&#x2F;app2&#x2F;url_reverse.html【重点3】</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5）效果：http-127-0-0-1-8000-url-reverse"><span class="nav-number">3.0.5.</span> <span class="nav-text">5）效果：http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;url_reverse&#x2F;</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-反向解析-动态传参"><span class="nav-number">3.1.</span> <span class="nav-text">3.2 反向解析+动态传参</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1）app2-views-py"><span class="nav-number">3.1.1.</span> <span class="nav-text">1）app2&#x2F;views.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2）【重点1：反向解析-传参配置url】app2-urls-py"><span class="nav-number">3.1.2.</span> <span class="nav-text">2）【重点1：反向解析+传参配置url】app2&#x2F;urls.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3）【重点2：反向解析-传参-模板写法】templates-app2-url-reverse-html"><span class="nav-number">3.1.3.</span> <span class="nav-text">3）【重点2：反向解析+传参+模板写法】templates&#x2F;app2&#x2F;url_reverse.html</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4）效果：http-127-0-0-1-8000-url-reverse"><span class="nav-number">3.1.4.</span> <span class="nav-text">4）效果：http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;url_reverse&#x2F;</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-views函数里调用反向解析-传参"><span class="nav-number">3.2.</span> <span class="nav-text">3.3 views函数里调用反向解析+传参</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1）app2-views-py【重点1】"><span class="nav-number">3.2.1.</span> <span class="nav-text">1）app2&#x2F;views.py【重点1】</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2）app2-urls-py-1"><span class="nav-number">3.2.2.</span> <span class="nav-text">2）app2&#x2F;urls.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3）其它配置见3-2（重点2）"><span class="nav-number">3.2.3.</span> <span class="nav-text">3）其它配置见3.2（重点2）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#效果：把1）步的【0-3】多选1解除注释查看效果"><span class="nav-number">3.2.4.</span> <span class="nav-text">效果：把1）步的【0-3】多选1解除注释查看效果</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="晨曦"
      src="http://www.zeyajt.com/u/40b74ddb-a87b-41cd-821b-3f6eeb544661/image/637203952121373129.jpg">
  <p class="site-author-name" itemprop="name">晨曦</p>
  <div class="site-description" itemprop="description">晨曦的技术博客，专注于python、vue、react、人工智能、爬虫、大数据分析</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/myblog/archives/">
        
          <span class="site-state-item-count">94</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/myblog/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/myblog/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">晨曦</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/myblog/lib/anime.min.js"></script>
  <script src="/myblog/lib/velocity/velocity.min.js"></script>
  <script src="/myblog/lib/velocity/velocity.ui.min.js"></script>

<script src="/myblog/js/utils.js"></script>

<script src="/myblog/js/motion.js"></script>


<script src="/myblog/js/schemes/pisces.js"></script>


<script src="/myblog/js/next-boot.js"></script>




  















  

  


 
</body>
</html>
